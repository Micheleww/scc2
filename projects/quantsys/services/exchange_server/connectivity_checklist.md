# Exchange Server 连通性自检清单

## 1. 本地服务检查

### 1.1 服务状态检查
- [ ] 服务是否正在运行
- [ ] 服务监听端口是否正确配置
- [ ] 服务日志中是否有错误信息

### 1.2 本地HTTP端点检查
- [ ] 健康检查端点: `curl -i http://localhost:18788/health`
  - 预期: HTTP 200 OK
  - 响应体: `{"status": "ok"}`

- [ ] JSON-RPC端点: `curl -i -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"ata.search","params":["test"],"id":1}' http://localhost:18788/rpc`
  - 预期: HTTP 200 OK
  - 响应体: 有效的JSON-RPC响应

- [ ] SSE端点: `curl -i http://localhost:18788/sse`
  - 预期: HTTP 200 OK
  - 响应头: `Content-Type: text/event-stream`
  - 响应头: `Cache-Control: no-cache`
  - 响应头: `Connection: keep-alive`
  - 预期: 接收到SSE事件流

## 2. Docker环境检查

### 2.1 Docker容器状态
- [ ] Docker服务是否正在运行
- [ ] 容器是否正在运行: `docker ps`
- [ ] 容器日志是否有错误: `docker logs exchange_server`

### 2.2 Docker网络检查
- [ ] 容器端口映射是否正确: `docker port exchange_server`
- [ ] 容器内部服务是否可访问: `docker exec -it exchange_server curl http://localhost:18788/health`

## 3. AWS部署检查

### 3.1 网络连接性
- [ ] EC2实例是否可通过SSH访问
- [ ] EC2实例安全组是否允许来自ALB的流量
- [ ] ALB安全组是否允许80/443端口入站

### 3.2 ALB检查
- [ ] ALB状态是否为"active"
- [ ] 目标组中EC2实例是否为"healthy"
- [ ] ALB访问日志是否正常记录

### 3.3 HTTPS/SSL检查
- [ ] SSL证书是否有效
- [ ] 是否强制使用HTTPS
- [ ] TLS版本是否为1.2+

## 4. SSE特定检查

### 4.1 连接持久性
- [ ] SSE连接是否能保持至少60秒
- [ ] 每30秒是否收到心跳消息
- [ ] 断开重连是否正常工作

### 4.2 性能检查
- [ ] 消息延迟是否在可接受范围内
- [ ] 同时连接数是否达到预期
- [ ] 高负载下是否稳定

## 5. JSON-RPC API检查

### 5.1 基本功能
- [ ] `ata.search`方法是否正常工作
- [ ] `ata.fetch`方法是否正常工作
- [ ] 错误处理是否正确

### 5.2 认证检查（如果启用）
- [ ] 无效认证是否返回401
- [ ] 有效认证是否返回200
- [ ] 认证过期处理是否正确

## 6. 监控与告警检查

### 6.1 CloudWatch指标
- [ ] ALB指标是否正常收集
- [ ] EC2指标是否正常收集
- [ ] 自定义SSE指标是否正常收集

### 6.2 告警配置
- [ ] 高CPU利用率告警是否配置
- [ ] 5XX错误率告警是否配置
- [ ] SSE连接异常告警是否配置

## 7. 灾难恢复检查

### 7.1 自动扩展
- [ ] 实例故障时是否自动替换
- [ ] 负载增加时是否自动扩容

### 7.2 跨AZ高可用
- [ ] 单AZ故障时服务是否可用
- [ ] 流量是否自动路由到健康AZ

## 8. 安全检查

### 8.1 网络安全
- [ ] 不必要的端口是否已关闭
- [ ] 安全组规则是否遵循最小化原则
- [ ] NACL配置是否正确

### 8.2 应用安全
- [ ] 是否使用最新的依赖版本
- [ ] 是否存在已知漏洞
- [ ] 日志中是否包含敏感信息

## 9. 性能优化检查

### 9.1 ALB优化
- [ ] Idle Timeout是否设置为60秒
- [ ] HTTP/1.1是否启用
- [ ] 连接复用是否正常工作

### 9.2 应用优化
- [ ] 响应头是否正确设置
- [ ] 缓存策略是否合理
- [ ] 资源使用是否高效

## 10. 最终验证

### 10.1 端到端测试
- [ ] 从外部网络访问ALB DNS是否成功
- [ ] JSON-RPC请求是否通过ALB正常响应
- [ ] SSE连接是否通过ALB正常建立

### 10.2 功能验证
- [ ] 完整的业务流程是否正常工作
- [ ] 错误场景是否正确处理
- [ ] 边界情况是否测试通过

## 自检结果记录

| 检查项 | 结果 | 备注 |
|--------|------|------|
| 本地服务状态 | | |
| JSON-RPC端点 | | |
| SSE端点 | | |
| Docker容器状态 | | |
| ALB健康状态 | | |
| HTTPS配置 | | |
| SSE连接持久性 | | |
| 监控告警 | | |
| 灾难恢复 | | |
| 安全配置 | | |
| 性能优化 | | |
| 端到端测试 | | |

## 问题排查指南

### 常见问题
1. **SSE连接频繁断开**
   - 检查ALB Idle Timeout设置
   - 检查应用层心跳机制
   - 检查网络连接稳定性

2. **502 Bad Gateway**
   - 检查EC2实例健康状态
   - 检查应用日志
   - 检查安全组配置

3. **JSON-RPC返回401**
   - 检查认证头是否正确
   - 检查API密钥是否有效
   - 检查认证服务是否正常

4. **高延迟**
   - 检查实例类型是否足够
   - 检查Auto Scaling配置
   - 检查ALB目标组健康检查间隔

### 日志位置
- 应用日志: `docker logs exchange_server` 或 `/var/log/exchange_server.log`
- ALB日志: S3存储桶
- EC2系统日志: CloudWatch Logs

### 紧急恢复步骤
1. 检查服务状态
2. 检查网络连接
3. 检查日志文件
4. 重启服务（如必要）
5. 触发自动扩展（如必要）
6. 联系支持团队
