# 统一服务器迁移提示词

## 任务概述

将系统中所有独立服务迁移到统一服务器，更改所有服务端口配置，删除反向代理，并扫描更新所有直接访问端口的代码。

---

## 任务1：更改所有下属服务功能使用的端口

### 1.1 识别需要更改的服务和端口

需要更改的服务端口配置：

| 服务 | 原端口 | 新端口 | 配置文件位置 |
|------|--------|--------|-------------|
| Exchange Server | 8080 | 已整合到统一服务器 | `tools/exchange_server/main.py` |
| A2A Hub | 5001 | 已整合到统一服务器 | `tools/a2a_hub/main.py` |
| MCP Bus | 8001 | 已整合到统一服务器 | `tools/mcp_bus/server/main.py` |
| 主应用服务器 | 8002 | 已整合到统一服务器 | `start_server_simple.py` 或相关启动脚本 |
| 反向代理 | 8000 | **删除** | `reverse_proxy.py` 或相关文件 |

### 1.2 更改服务启动代码

**提示词：**

```
请执行以下操作：

1. 在以下文件中，注释掉或删除所有启动独立服务器的代码（app.run, uvicorn.run, web.run_app等）：
   - tools/exchange_server/main.py
   - tools/a2a_hub/main.py
   - tools/mcp_bus/server/main.py
   - start_server_simple.py（如果存在）
   - 其他启动独立服务的脚本

2. 在 if __name__ == "__main__": 代码块中添加检查：
   - 如果环境变量 UNIFIED_SERVER_MODE=true，则只输出提示信息，不启动服务器
   - 提示信息："此服务已整合到统一服务器，请使用统一服务器访问"

3. 保留服务类和函数定义，只禁用独立启动功能

4. 确保统一服务器可以通过 importlib 正常导入这些服务
```

### 1.3 更新配置文件

**提示词：**

```
请更新以下配置文件，将端口配置标记为已弃用：

1. PORT_CONFIG_README.md
   - 在"固定端口配置"部分添加"已弃用"标记
   - 添加说明：所有服务已整合到统一服务器（端口18788）
   - 更新端口映射表

2. 所有 .env 文件
   - 注释掉或删除端口配置
   - 添加注释说明使用统一服务器

3. docker-compose.yml 文件（如果存在）
   - 更新端口映射，指向统一服务器
```

---

## 任务2：删除反向代理

### 2.1 识别反向代理文件

**提示词：**

```
请查找并识别以下反向代理相关文件：

1. 搜索包含以下关键词的文件：
   - "reverse_proxy"
   - "proxy"
   - "8000" (反向代理常用端口)
   - "nginx" 或 "caddy" 配置

2. 可能的位置：
   - reverse_proxy.py
   - tools/reverse_proxy/
   - configs/reverse_proxy/
   - nginx.conf 或 caddy.conf
   - docker-compose.yml 中的反向代理服务

3. 列出所有找到的文件和它们的作用
```

### 2.2 删除反向代理代码

**提示词：**

```
请执行以下操作删除反向代理：

1. 删除或重命名以下文件（移动到 isolated_observatory）：
   - reverse_proxy.py
   - 所有反向代理配置文件
   - 反向代理启动脚本

2. 在以下文件中删除反向代理相关代码：
   - start_all_services.py（如果包含反向代理启动）
   - stop_all_services.py（如果包含反向代理停止）
   - 其他启动脚本

3. 更新文档：
   - PORT_CONFIG_README.md：删除反向代理相关说明
   - README.md：删除反向代理相关章节
   - 项目导航文档：更新服务架构说明

4. 创建迁移记录：
   - 记录删除的文件列表
   - 记录删除的原因（已整合到统一服务器）
```

---

## 任务3：扫描所有调用了端口的直接访问，改为统一服务器

### 3.1 扫描直接端口访问

**提示词：**

```
请扫描整个代码库，查找所有直接访问以下端口的代码：

1. 搜索模式：
   - "http://localhost:18788/"
   - "http://127.0.0.1:18788/"
   - "http://localhost:18788/api"
   - "http://127.0.0.1:18788/api"
   - "http://localhost:18788/mcp"
   - "http://127.0.0.1:18788/mcp"
   - "http://localhost:18788/"
   - "http://127.0.0.1:18788/"
   - "http://localhost:18788/"（反向代理）
   - "http://127.0.0.1:18788/"
   - 端口号：8080, 5001, 8001, 8002, 8000

2. 搜索位置：
   - 所有 .py 文件
   - 所有 .js/.ts 文件
   - 所有 .json 配置文件
   - 所有 .md 文档
   - 所有 .yaml/.yml 配置文件
   - 所有 .sh/.ps1/.bat 脚本

3. 生成报告：
   - 列出所有找到的文件和行号
   - 标注每个引用的上下文
   - 分类：代码引用、配置引用、文档引用
```

### 3.2 更新代码引用

**提示词：**

```
请更新所有找到的直接端口访问，改为统一服务器访问：

1. 端口映射规则：
   - http://localhost:18788/* → http://localhost:18788/exchange/*
   - http://localhost:18788/api/* → http://localhost:18788/api/*
   - http://localhost:18788/mcp/* → http://localhost:18788/mcp/*
   - http://localhost:18788/* → http://localhost:18788/*（根据具体路径）
   - http://localhost:18788/* → http://localhost:18788/*（反向代理）

2. 更新方式：
   - Python代码：使用 BASE_URL = "http://localhost:18788" 常量
   - JavaScript/TypeScript：使用 const BASE_URL = 'http://localhost:18788'
   - 配置文件：更新URL配置
   - 文档：更新访问地址说明

3. 特殊处理：
   - 环境变量：更新环境变量配置
   - 测试代码：更新测试URL
   - 客户端配置：更新客户端连接配置（如 .trae/mcp.json）

4. 保持向后兼容（可选）：
   - 添加重定向逻辑（如果需要）
   - 添加配置选项支持旧端口（过渡期）
```

### 3.3 创建更新脚本

**提示词：**

```
请创建一个自动化脚本 update_port_references.py，用于批量更新端口引用：

1. 功能：
   - 扫描所有文件
   - 查找端口引用
   - 自动替换为统一服务器地址
   - 生成更新报告
   - 支持回滚

2. 配置：
   - 端口映射配置（JSON格式）
   - 排除文件列表（.git, node_modules等）
   - 备份原始文件

3. 安全：
   - 先备份所有文件
   - 显示预览，确认后执行
   - 支持dry-run模式
   - 记录所有更改
```

---

## 任务4：验证和测试

### 4.1 验证更改

**提示词：**

```
请执行以下验证步骤：

1. 端口检查：
   - 确认8080, 5001, 8001, 8002, 8000端口未被占用
   - 确认统一服务器18788端口正常监听

2. 服务访问测试：
   - 测试 http://localhost:18788/exchange/version
   - 测试 http://localhost:18788/api/health
   - 测试 http://localhost:18788/mcp
   - 测试所有整合的服务端点

3. 代码引用验证：
   - 运行所有测试脚本
   - 检查客户端连接
   - 验证配置文件

4. 文档验证：
   - 检查所有文档中的端口引用已更新
   - 确认没有遗漏的旧端口引用
```

### 4.2 更新文档

**提示词：**

```
请更新以下文档：

1. PORT_CONFIG_README.md：
   - 标记所有旧端口为"已弃用"
   - 添加统一服务器说明
   - 更新端口映射表

2. 项目导航文档：
   - 更新服务架构说明
   - 删除反向代理相关章节
   - 添加统一服务器迁移说明

3. README.md：
   - 更新快速开始指南
   - 删除多端口模式说明
   - 添加统一服务器使用说明

4. 创建迁移指南：
   - 记录迁移步骤
   - 列出所有更改
   - 提供回滚方案
```

---

## 执行顺序建议

1. **第一步**：扫描和识别（任务3.1）
   - 先全面扫描，了解影响范围
   - 生成详细报告

2. **第二步**：更改服务端口（任务1）
   - 禁用独立服务启动
   - 更新配置文件

3. **第三步**：删除反向代理（任务2）
   - 删除相关文件和代码
   - 更新文档

4. **第四步**：更新代码引用（任务3.2）
   - 使用自动化脚本批量更新
   - 手动检查关键文件

5. **第五步**：验证和测试（任务4）
   - 全面测试
   - 更新文档

---

## 注意事项

1. **备份**：在执行任何更改前，先备份所有文件
2. **测试**：每次更改后都要测试，确保功能正常
3. **文档**：及时更新文档，保持同步
4. **回滚**：准备回滚方案，以防出现问题
5. **兼容性**：考虑过渡期兼容性，可能需要同时支持新旧方式一段时间

---

## 预期结果

完成迁移后：

1. ✅ 所有服务通过统一服务器（18788端口）访问
2. ✅ 所有旧端口（8080, 5001, 8001, 8002, 8000）不再使用
3. ✅ 反向代理已删除
4. ✅ 所有代码引用已更新为统一服务器
5. ✅ 所有文档已更新
6. ✅ 测试通过，功能正常
