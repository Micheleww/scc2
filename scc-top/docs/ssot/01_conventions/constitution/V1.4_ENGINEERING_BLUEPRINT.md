---
oid: 01KGFSKN17TZZTVJS195JVJ765
layer: DOCOPS
primary_unit: V.GUARD
tags: [S.NAV_UPDATE]
status: active
---

# QuantSys V1.4 工程实现蓝图

## 一、模块级工程拆解

### 1. Belief Layer
- **职责**：生成原始 Market Belief，包含方向、幅度、时间三个维度的概率分布
- **不做什么**：不进行校准，不直接影响仓位
- **上游输入**：Features
- **下游输出**：MarketBeliefRaw 到 Belief Calibration & Scoring
- **防御风险**：模型错误出局（基础层）
- **是否唯一合法入口**：是，所有市场概率必须从此层产生

### 2. Belief Calibration & Scoring
- **职责**：
  - 校准原始 belief，确保概率“说实话”
  - 评估 belief 健康度，判断是否“值得信任”
- **不做什么**：不产生交易信号
- **上游输入**：MarketBeliefRaw
- **下游输出**：MarketBeliefCalibrated 到 State & Weight Estimation
- **防御风险**：模型错误出局
- **是否唯一合法入口**：是，所有 belief 必须经过此层才能进入风险决策

### 3. State & Weight Estimation
- **职责**：
  - 基于校准后的 belief 计算风险强度 w ∈ [0,1]
  - 生成解释性状态标签（RANGE/TRANSITION/TREND）
- **不做什么**：不直接决定仓位大小
- **上游输入**：MarketBeliefCalibrated
- **下游输出**：w 和 state_label 到 Risk Budget Management
- **防御风险**：模型错误出局
- **是否唯一合法入口**：是，所有风险预算计算必须基于此层的 w

### 4. Risk Budget Management
- **职责**：
  - 计算账户层面的 base_risk（单笔最大可承受损失）
  - 基于 w² 和 belief health 计算 effective_risk
  - 应用连续亏损、回撤等约束
- **不做什么**：不直接计算仓位
- **上游输入**：w, state_label, belief health score
- **下游输出**：effective_risk 到 Position Sizing
- **防御风险**：连续亏损出局
- **是否唯一合法入口**：是，所有仓位计算必须基于此层的 effective_risk

### 5. Per-unit Risk Estimation
- **职责**：
  - 保守估计每单位仓位的最坏风险
  - 计算组成：止损损失 + 滑点缓冲 + 手续费 + 尾部/跳空缓冲
- **不做什么**：不考虑期望收益
- **上游输入**：MarketBeliefCalibrated, 市场数据
- **下游输出**：per_unit_risk 到 Position Sizing
- **防御风险**：单次爆亏出局
- **是否唯一合法入口**：是，所有仓位计算必须使用此层的 per_unit_risk

### 6. Position Sizing
- **职责**：
  - 基于 effective_risk / per_unit_risk 计算最终仓位
  - 应用交易所/系统仓位上限约束
- **不做什么**：不使用胜率、Kelly、期望收益
- **上游输入**：effective_risk, per_unit_risk
- **下游输出**：position_size 到 Strategy Layer
- **防御风险**：单次爆亏出局
- **是否唯一合法入口**：是，所有策略必须使用此层的仓位大小

### 7. Strategy Layer
- **职责**：生成具体的交易订单（入场/出场/加仓），但不修改仓位大小
- **不做什么**：不绕过 risk budget，不修改 position_size
- **上游输入**：position_size, MarketBeliefCalibrated, state_label
- **下游输出**：orders 到 Execution Layer
- **防御风险**：无直接防御，依赖上游风险控制
- **是否唯一合法入口**：是，所有订单必须从此层产生

### 8. Execution Layer
- **职责**：安全执行订单，处理滑点、点差、深度等门禁
- **不做什么**：不修改订单大小，不执行风险超标的订单
- **上游输入**：orders, market data
- **下游输出**：fills 到 Observability & Audit Layer
- **防御风险**：单次爆亏出局（执行层面）
- **是否唯一合法入口**：是，所有交易必须从此层执行

### 9. Risk Guard & Circuit Breaker
- **职责**：
  - 监控系统状态，执行断路器逻辑
  - 可直接将 effective_risk 降为 0
  - 管理系统状态（NORMAL/DEGRADED/HALT）
- **不做什么**：不产生交易信号
- **上游输入**：全局系统状态，包括 PnL、仓位、市场异常等
- **下游输出**：system_state 到所有模块
- **防御风险**：连续亏损出局、单次爆亏出局
- **是否唯一合法入口**：是，所有风险紧急干预必须从此层发起

### 10. Observability & Audit Layer
- **职责**：记录所有关键决策数据，确保可追溯性
- **不做什么**：不影响交易决策
- **上游输入**：所有模块的关键输出
- **下游输出**：日志、报告、审计数据
- **防御风险**：所有风险（通过事后审计）
- **是否唯一合法入口**：是，所有关键数据必须从此层记录

## 二、w → 仓位 的工程因果链

```
Market Belief → Belief Calibration / Scoring → State & Weight (w) → Risk Budget → per_unit_risk → Position → Strategy → Execution
```

### 1. Market Belief → Belief Calibration / Scoring
- **允许**：生成三维概率分布
- **禁止**：直接输出仓位建议
- **风险放大点**：无
- **风险硬约束点**：所有 belief 必须经过校准

### 2. Belief Calibration / Scoring → State & Weight (w)
- **允许**：基于校准后的 belief 计算 w
- **禁止**：使用未经校准的 belief
- **风险放大点**：w 的计算逻辑
- **风险硬约束点**：w ∈ [0,1]

### 3. State & Weight (w) → Risk Budget
- **允许**：effective_risk = base_risk × w²
- **禁止**：直接使用 w 计算仓位，跳过 w² 惩罚
- **风险放大点**：w² 的映射关系
- **风险硬约束点**：belief health 只能降低 effective_risk

### 4. Risk Budget → per_unit_risk
- **允许**：保守估计单位风险
- **禁止**：使用期望收益计算单位风险
- **风险放大点**：per_unit_risk 的估计不足
- **风险硬约束点**：必须包含尾部缓冲

### 5. Risk Budget + per_unit_risk → Position
- **允许**：position_size = effective_risk / per_unit_risk
- **禁止**：使用胜率、Kelly、期望收益计算仓位
- **风险放大点**：仓位计算错误
- **风险硬约束点**：严格遵循公式

### 6. Position → Strategy → Execution
- **允许**：生成订单并执行
- **禁止**：修改仓位大小，跳过风险控制
- **风险放大点**：执行滑点超出预期
- **风险硬约束点**：断路器可随时中断执行

## 三、制度性约束的工程强制执行

### 1. 防止违规仓位计算
- **工程实现**：
  - Position Sizing 模块仅接受 effective_risk 和 per_unit_risk 作为输入
  - 禁止该模块访问任何胜率、期望收益相关数据
  - 单元测试确保公式严格执行

### 2. 防止跳过风险控制
- **工程实现**：
  - 单向数据流：Belief → w → Risk Budget → Position → Strategy → Execution
  - 各模块仅能访问上游输出，不能反向调用
  - 策略模块仅能读取 position_size，不能修改
  - Execution 模块检查订单是否符合风险预算

### 3. 只读参数与风险降低
- **工程实现**：
  - base_risk 为只读参数，仅可通过配置修改
  - belief health score 仅用于降低 effective_risk，不能放大
  - w_cap 只能向下调整，不能向上突破配置上限
  - 所有风险相关参数修改需经过审计

### 4. 空仓作为主动决策
- **工程实现**：
  - 当 w < w_min 或 belief health 过低时，系统自动设置 position_size = 0
  - 空仓状态需记录明确原因
  - 空仓不触发任何告警，视为正常决策

## 四、三类“出局风险”的工程对应表

| 出局风险类型 | 工程中由哪些模块防御 | 防御方式 |
|--------------|---------------------|----------|
| 连续亏损出局 | Risk Budget Management, Risk Guard & Circuit Breaker | 1. 单笔风险上限（effective_risk）<br>2. 日/周亏损限额<br>3. 连错降档（w_cap 下调）<br>4. 最大回撤 HALT |
| 单次爆亏出局 | Per-unit Risk Estimation, Position Sizing, Execution Layer | 1. per_unit_risk 包含尾部缓冲<br>2. 严格仓位计算公式<br>3. 执行层面的滑点/点差门禁<br>4. 禁止满仓/极限暴露 |
| 模型错误出局 | Belief Calibration & Scoring, State & Weight Estimation, Risk Guard & Circuit Breaker | 1. belief 校准确保概率可靠<br>2. health score 评估可信度<br>3. 模型不可信时自动降低风险<br>4. 定期模型重校准与验证 |

## 五、Observability（审计）的工程化要求

### 1. 必须记录的关键变量
- raw belief（三维概率分布）
- calibrated belief（含校准元数据）
- belief health score（direction/magnitude/time/overall）
- w 和 state_label
- base_risk 和 effective_risk
- per_unit_risk 的各组成项（止损/滑点/手续费/尾部缓冲）
- 最终 position_size
- 生成的订单详情
- 执行结果（fills）
- 系统状态（NORMAL/DEGRADED/HALT）
- 任何风险规则的触发情况

### 2. 记录时点
- 每次 belief 更新时
- 每次 w 计算时
- 每次 risk budget 计算时
- 每次仓位计算时
- 每次订单生成时
- 每次订单执行时
- 每次风险规则触发时

### 3. 用于事后回答的问题
- 为什么当时生成了这个 belief？
- 当时的 belief 健康度如何？
- 为什么 w 是这个值？
- 为什么 effective_risk 是这个值？
- 为什么仓位是这个大小？
- 当时是否考虑了足够的尾部风险？
- 是否有风险规则限制了仓位？
- 系统当时处于什么状态？

## 六、禁止项

### 1. 违反宪法精神的实现方式
- 使用胜率、期望收益或 Kelly 比例直接计算仓位
- 跳过 w 或 risk budget 直接下单
- 修改 position_size 计算公式
- 允许 belief health 放大风险
- 不记录关键决策数据
- 将空仓视为错误状态
- 允许策略直接访问市场数据生成仓位
- 绕过 belief 校准直接使用原始概率

### 2. 破坏系统风险哲学的错误点
- 仓位计算不考虑 per_unit_risk
- 风险预算不使用 w² 惩罚
- 不包含尾部风险缓冲
- 允许反向数据流
- 断路器优先级低于策略
- 不限制最大仓位
- 允许连续亏损累积

## 工程落地要点摘要

1. 严格遵循单向数据流，确保风险控制层层传递
2. 所有仓位计算必须基于 effective_risk / per_unit_risk 公式
3. 三类出局风险需对应模块进行防御
4. 核心参数（w、effective_risk、per_unit_risk）必须可审计
5. 信念健康度只能降低风险，不能放大
6. 空仓是主动决策，需记录原因
7. 断路器具备最高优先级，可随时中断交易
8. 所有关键决策数据必须实时记录，确保可追溯

SUBMIT
